<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Linux] Fast-VM 설치 및 활용 | chhanz 기술 블로그
</title>
<meta name="keywords" content="linux, fast-vm">
<meta name="description" content=" ">
<meta name="author" content="chhanz">
<link rel="canonical" href="https://chhanz88.github.io/post/2019-08-16-linux-fast-vm/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js" integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://chhanz88.github.io/assets/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://chhanz88.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://chhanz88.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://chhanz88.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://chhanz88.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="[Linux] Fast-VM 설치 및 활용" />
<meta property="og:description" content=" " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chhanz88.github.io/post/2019-08-16-linux-fast-vm/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-08-16T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2019-08-16T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Linux] Fast-VM 설치 및 활용"/>
<meta name="twitter:description" content=" "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://chhanz88.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "[Linux] Fast-VM 설치 및 활용",
      "item": "https://chhanz88.github.io/post/2019-08-16-linux-fast-vm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Linux] Fast-VM 설치 및 활용",
  "name": "[Linux] Fast-VM 설치 및 활용",
  "description": " ",
  "keywords": [
    "linux", "fast-vm"
  ],
  "articleBody": "Fast-VM  Fast-VM 이란?  Fast-VM 라는 Open Source Solution 을 알게된 것은 Ondrej Faměra 라는 친구를 만나면서 입니다.\nThank You. Ondrej ^o^\n Fast-VM 은 Ondrej Faměra 가 만든 libvirtd 기반의 가상화 Provisioning Solution 입니다.\n기존의 libvirtd 기반의 가상화는 virt-manager 혹은 virsh 을 통해 VM 생성 및 운영을 하였습니다.\nFast-VM 을 이용하면 fast-vm 이라는 명령어 하나로 VM을 생성하고 관리 할 수 있습니다.\n다양한 Linux 배포판을 설치하고 테스트를 해야되는 저는 fast-vm 을 통해 여러가지 스트레스들이 사라졌습니다. ^^\nFast-VM 설치 fast-vm 의 설치 환경은 아래와 같습니다.\n  CentOS/RHEL 7.6 and Fedora 28, 29, 30, RHEL system KVM 가상화를 사용 할 수 있도록 CPU 가상화 기능 활성화 LVM Pool 공간으로 사용될 Free VG 공간 Package 설치를 위한 Public Network 연결 허용   fast-vm 설치는 ansible 을 이용하여 간편하게 설치가 가능합니다.\n[root@fastvm-host ~]# yum -y install ansible 먼저 ansible 을 설치합니다.\n[root@fastvm-host ~]# ansible-galaxy install ondrejhome.fast-vm-server - downloading role 'fast-vm-server', owned by ondrejhome - downloading role from https://github.com/OndrejHome/ansible.fast-vm-server/archive/v6.tar.gz - extracting ondrejhome.fast-vm-server to /etc/ansible/roles/ondrejhome.fast-vm-server - ondrejhome.fast-vm-server (v6) was installed successfully [root@fastvm-host ~]# ansible-galaxy 명령을 통해 fast-vm playbook 을 Download 합니다.\n[root@fastvm-host defaults]# vgs  VG #PV #LV #SN Attr VSize VFree  centos 1 2 0 wz--n- 278.36g [root@fastvm-host defaults]# 위와 같이 Free Size 의 VG 를 준비합니다.\n[root@fastvm-host defaults]# pwd /etc/ansible/roles/ondrejhome.fast-vm-server/defaults  [root@fastvm-host defaults]# cat main.yml --- ### areas that can be configured by this role  ## configure repositories needed for fast-vm installation config_repositories: true ## install packages needed by fast-vm and fast-vm itself install_fastvm: true ## configure libvirt for fast-vm access (change groups and permissions settings) config_libvirt_access: true ## configure libvirt network for fast-vm (libvirtd service will be enabled after boot) config_libvirt_network: true ## configure storage for fast-vm (create thinpool LV) config_storage: true ## configure sudoers for fast-vm config_sudoers: true ## generate /etc/fast.conf configuration file config_fastvm_conf: true ## install OVMF UEFI firmware needed by UEFI fast-vm machines install_ovmf: true ## install and configure fence_virtd that can be used to fence the fast-vm VMs using fence_xvm install_fence_virtd: true ## install custom version of qemu-kvm,qemu-img and seabios-bin to support LSI and MEGASAS emaulated drivers install_custom_qemu: true  ### variable that are required by some areas from above # all variable has list of 'required by' on which above options needs them  ## group with access to fast-vm # required by: config_libvirt_access, config_sudoers, config_fastvm_conf fastvm_group: libvirt  ## name of VG where fast-vm thinpool LV is located # required by: config_storage, config_fastvm_conf fastvm_vg: centos  ## name of fast-vm thinpool LV # required by: config_storage, config_fastvm_conf fastvm_lv: fast-vm-pool  ## size of fast-vm thinpool LV # required by: config_storage, config_fastvm_conf fastvm_lv_size: 100G  ## fast-vm network subnet number # required by: config_libvirt_network, config_fastvm_conf fastvm_net: 100  ## name of fast-vm NAT libvirt network # required by: config_libvirt_network, config_fastvm_conf, install_fence_virt fastvm_net_name: fast-vm-nat  ## prefix for fast-vm VMs # required by: config_fastvm_conf fastvm_vm_prefix: 'fastvm-'  ## fast-vm notes directory - here fast-vm stores VM notes and other VM stateful details # required by: config_fastvm_conf fastvm_notes_dir: '/var/tmp'  ## Allow only owners of VMs and 'root' to delete them # required by: config_fastvm_conf fastvm_owner_only_delete: 'yes'  ## Multicast address of fence_virt daemon # required by: install_fence_virt fence_virtd_address: '225.0.0.12' [root@fastvm-host defaults]# /etc/ansible/roles/ondrejhome.fast-vm-server/defaults 위 경로의 main.yml 을 설치 환경에 맞게 설정합니다. (현재는 firewalld 설정 관련 Option 을 추가 하였습니다. 상세 내용은 하단에 첨부하도록 하겠습니다.)\n/etc/ansible/roles/ondrejhome.fast-vm-server/defaults/main.yml 에서 아래 Option 을 시스템 환경에 맞게 설정하였습니다.\nfastvm_vg: centos fastvm_lv_size: 100G [root@fastvm-host ~]# cat install.yaml - hosts: localhost  roles:  - { role: ondrejhome.fast-vm-server } 위와 같이 localhost 에 설치하도록 ansible-playbook 을 작성합니다.\n[root@fastvm-host ~]# ansible-playbook install.yaml ... 중략 ... TASK [ondrejhome.fast-vm-server : make fence_xvm.key readable by everyone] ************************************************************************************** ok: [localhost] TASK [ondrejhome.fast-vm-server : generate /etc/fence_virt.conf configuration] ************************************************************************************** ok: [localhost] TASK [ondrejhome.fast-vm-server : start and enable fence_virtd service] ************************************************************************************** changed: [localhost] TASK [ondrejhome.fast-vm-server : install custom qemu-kvm, qemu-img and seabios-bin packages] **************************************************************************************  [WARNING]: Consider using yum module rather than running yum changed: [localhost] PLAY RECAP *************************************************************************** localhost : ok=28 changed=2 unreachable=0 failed=0 [root@fastvm-host ~]# 위와 같이 설치가 손쉽게 되는 것을 볼 수 있습니다.\nFast-VM 운영  Show VM List [root@fastvm-host ~]# fast-vm list VM# Image name Status Profile_name Size( %used ) Activity Notes === Space used: 0.00% of 100.00g [root@fastvm-host ~]# Import OS Images fast-vm Document Page 를 참조하면 다양한 Linux 배포판 Template 가 생성 되어 있고, 사용이 가능합니다.\n Image List : https://www.famera.cz/blog/fast-vm/image_list.html  해당 Page 를 통해 Os Image 를 Import 하도록 하겠습니다.\n[root@test-vm-host ~]# fast-vm import_image centos-6.9 http://ftp.linux.cz/pub/linux/people/ondrej_famera/fastvm-images/generated/6g__centos-6.9.img.xz \\  https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/xml/centos-6.3-current.xml \\  https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/hacks/6g_centos-6-hacks.sh [__][inf] provided empty file path [__][inf] Detected remote file with size 199916708 [__][inf] provided empty file path [__][inf] Detected remote file with size 1596 [__][inf] downloading https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/xml/centos-6.3-current.xml [__]into /tmp/tmp.Ca4rz7xD9y [__][inf] provided empty file path [__][inf] Detected remote file with size 1334 [__][inf] downloading https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/hacks/6g_centos-6-hacks.sh [__]into /tmp/tmp.6QO7k5K5zK [__][inf] Size of image was determined from the filename to be 6G. [__][inf] creating LV fastvm-centos-6.9 ... [__][inf] importing image http://ftp.linux.cz/pub/linux/people/ondrej_famera/fastvm-images/generated/6g__centos-6.9.img.xz into /dev/c7vg/fastvm-centos-6.9 [__][inf] please wait while importing image (to show image write progress, install 'pv')  % Total % Received % Xferd Average Speed Time Time Time Current  Dload Upload Total Spent Left Speed 100 190M 100 190M 0 0 3180k 0 0:01:01 0:01:01 --:--:-- 55347 0+640923 records in 0+640923 records out 6442450944 bytes (6.4 GB) copied, 62.6419 s, 103 MB/s [__][ok] Image centos-6.9 imported [root@test-vm-host ~]# 위와 같이 Image 를 Download 하고 fast-vm 에 Import 하였습니다.\n[root@test-vm-host ~]# fast-vm list_images IMAGE |SYSTEM |USER | Image name Size |XML Hack file for|XML Hack file for| centos-6.10 6g |ok create |missing no hack files| centos-6.9 6g |ok create |missing no hack files| centos-7.3 6g |ok create |missing no hack files| centos-7.6 6g |ok create |missing no hack files| centos-7.6-ext 6g |ok create |missing no hack files| NOTE: if image is missing XML it wouldn't be possible to create a VM from it!  Image with missing hack file(s) can work if it's not needed.  USER XML and hack file(s) takes precendense before SYSTEM ones. [root@test-vm-host ~]# CentOS 6.9 가 Import 되었습니다.\nhack file 수정 기본적으로 제공된 OS Image 는 유럽 Timezone 이 설정 되어 있습니다.\n그리하여 hack file 을 수정하여 아시아 Timezone 으로 변경을 할 수 있고, 이를 응용하여 나만의 Custom Image 를 생성 할 수 있습니다.\n$ vi /etc/fast-vm/hacks-centos-6.9.sh  #!/bin/bash ## test if guestfish command is present which guestfish 2\u00261  /dev/null if [ \"$?\" != 0 ]; then  echo \"[!!!] Command 'guestfish' not found (Install it!). Making changes to VM FAILED.\"  exit 1 fi ## using direct backend to avoid selinux issues on fedora for now export LIBGUESTFS_BACKEND=direct ## hostname VM_HOSTNAME=$(echo $VM_NAME|sed -e 's/\\./-/g; s/_/-/g')  guestfish -a \"/dev/$THINPOOL_VG/$VM_NAME\" -m /dev/c6vg/root_lv -m /dev/sda1:/boot # configure correct MAC address for eth0 network adapter sh 'sed -i \"s/HWADDR=.*$/HWADDR=\\\"${VM_MAC}\\\"/; s/^ONBOOT=.*$/ONBOOT=\\\"yes\\\"/\" /etc/sysconfig/network-scripts/ifcfg-eth0' # change the hostname of machine sh 'sed -i \"s/HOSTNAME=.*$/HOSTNAME=$VM_HOSTNAME/\" /etc/sysconfig/network'  ++ # Change Timezone ++ sh 'rm -f /etc/localtime' ++ sh 'ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime'  # CentOS 6.4, 6.4, 6.5 contained broken line in 'file_contexts' file, this removes it so we can apply other selinux labels sh 'sed -i \"/\\\\pid/d\" /etc/selinux/targeted/contexts/files/file_contexts' selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/selinux/targeted/contexts/files/file_contexts # relabel files that we were touching with correct SELinux labels selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/sysconfig/network-scripts/ifcfg-eth0 selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/sysconfig/network EOF 위와 같이 guestfish 명령을 통해 Image 변경 작업을 할 수 있도록 설정합니다.\nStart fast-vm 수정된 Image 를 이용하여 VM 을 생성 하도록 하겠습니다.\n[root@test-vm-host ~]# fast-vm create centos-6.9 30 [30][inf] using file /etc/fast-vm/config-centos-6.9.xml as libvirt XML [30][inf] using file /etc/fast-vm/hacks-centos-6.9.sh as hack file [30][inf] defining virtual machine 'fastvm-centos-6.9-30' in libvirt Domain fastvm-centos-6.9-30 defined from /tmp/tmp.AUMMkEdrbo.xml Domain title updated successfully [30][inf] creating disk 'fastvm-centos-6.9-30' [30][inf] adding static lease for 192.168.200.30 into libvirts DHCP [30][inf] applying hacks from /etc/fast-vm/hacks-centos-6.9.sh [30][inf] applying hacks finished [30][ok] VM 'fastvm-centos-6.9-30' created VM ID 30 으로 VM 이 생성 되었습니다.\n[root@test-vm-host ~]# fast-vm start 30 [30][inf] starting VM fastvm-centos-6.9-30 (192.168.200.30) Domain fastvm-centos-6.9-30 started VM ID 30 의 VM 을 시작 하였습니다.\n[root@test-vm-host ~]# fast-vm ssh 30 [30][inf] checking the 192.168.200.30 for active SSH connection (ctrl+c to interrupt) ................[30][inf] [30]SSH ready Warning: Permanently added '192.168.200.30' (RSA) to the list of known hosts. root@192.168.200.30's password: fast-vm ssh 명령을 통해 해당 VM 에 ssh 로 접속을 합니다.\n시스템이 부팅중일 경우, ssh 서비스가 시작 될 때까지 접속 대기합니다.\n 참고 : 기본적으로 사용되는 이미지의 root 비밀번호는 testtest 입니다.  [root@fastvm-centos-6-9-30 ~]# cat /etc/redhat-release CentOS release 6.9 (Final) [root@fastvm-centos-6-9-30 ~]# date Fri Aug 16 11:02:43 KST 2019 위와 같이 VM 이 생성 및 시작, hack file 이 적용된 것을 확인 할 수 있습니다.\nDelete fast-vm 아래 명령을 통해 사용을 다한 fast-vm 을 삭제 할 수 있습니다.\n[root@test-vm-host fast-vm]# fast-vm delete 30 [30][wrn] VM fastvm-centos-6.9-30 is active, forcefully stopping it Domain fastvm-centos-6.9-30 destroyed [30][inf] removing DHCP reservation 192.168.200.30 for 52:54:00:96:5c:80 Updated network fast-vm-nat persistent config and live state [30][inf] removing VM drive [30][inf] undefining VM fastvm-centos-6.9-30 from libvirt Domain fastvm-centos-6.9-30 has been undefined [30][ok] VM 'fastvm-centos-6.9-30' deleted [root@test-vm-host fast-vm]# 해당 VM 이 삭제 되었습니다.\nfast-vm 에 PR 을 해보자!  fast-vm 은 Open Source Solution 으로 언제나 Github를 통해 PR 을 할 수 있습니다.\n저의 경우, 아래와 같은 이슈로 인해 PR 진행 하였습니다.\n firewalld deamon 의 disable 로 인한 배포 실패 지원하는 ansible 최소버전에 대한 이슈. ( yum Module update_only option 관련 )  위와 같이 PR 을 생성하고 현재는 Source 에 Merge 되었습니다.\n마치며 위에서 소개한 fast-vm 의 부분은 극히 필수적인 요소들입니다.\nlibvirtd 에서 제공하는 다양한 부분을 지원하고 있으며, 해당 내용은 아래 참고 문서 를 확인 바람니다.\n***사용 중 발생된 이슈/추가 기능 구현 관련에 대해 github 를 통해 PR 할 수 있습니다. ***\n참고 문서  github : https://github.com/OndrejHome/ansible.fast-vm-server Fast-VM User Guide : https://www.famera.cz/blog/fast-vm/user_guide.html Fast-VM Image List : https://www.famera.cz/blog/fast-vm/image_list.html  ",
  "wordCount" : "1542",
  "inLanguage": "en",
  "datePublished": "2019-08-16T00:00:00Z",
  "dateModified": "2019-08-16T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "chhanz"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chhanz88.github.io/post/2019-08-16-linux-fast-vm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "chhanz 기술 블로그\n",
    "logo": {
      "@type": "ImageObject",
      "url": "https://chhanz88.github.io/assets/favicon.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chhanz88.github.io" accesskey="h" title="chhanz 기술 블로그
 (Alt + H)">chhanz 기술 블로그
</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chhanz88.github.io/categories/" title="categories">
                    <span>categories</span>
                </a>
            </li>
            <li>
                <a href="https://chhanz88.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      [Linux] Fast-VM 설치 및 활용
    </h1>
    <div class="post-description">
       
    </div>
    <div class="post-meta"><span title='2019-08-16 00:00:00 +0000 UTC'>August 16, 2019</span>&nbsp;·&nbsp;chhanz

</div>
  </header> 
  <div class="post-content"><h1 id="fast-vm">Fast-VM<a hidden class="anchor" aria-hidden="true" href="#fast-vm">#</a></h1>
<hr>
<h2 id="fast-vm-이란">Fast-VM 이란?<a hidden class="anchor" aria-hidden="true" href="#fast-vm-이란">#</a></h2>
<blockquote>
<p><code>Fast-VM</code> 라는 <em>Open Source Solution</em> 을 알게된 것은 <em>Ondrej Faměra</em> 라는 친구를 만나면서 입니다.<br>
<em><strong>Thank You. Ondrej ^o^</strong></em></p>
</blockquote>
<p><code>Fast-VM</code> 은 <em>Ondrej Faměra</em> 가 만든 libvirtd 기반의 가상화 Provisioning Solution 입니다.<br>
기존의 libvirtd 기반의 가상화는 virt-manager 혹은 virsh 을 통해 VM 생성 및 운영을 하였습니다.</p>
<p><code>Fast-VM</code> 을 이용하면 <code>fast-vm</code> 이라는 명령어 하나로 VM을 생성하고 관리 할 수 있습니다.<br>
다양한 Linux 배포판을 설치하고 테스트를 해야되는 저는 <code>fast-vm</code> 을 통해 여러가지 스트레스들이 사라졌습니다. ^^</p>
<h2 id="fast-vm-설치">Fast-VM 설치<a hidden class="anchor" aria-hidden="true" href="#fast-vm-설치">#</a></h2>
<p><code>fast-vm</code> 의 설치 환경은 아래와 같습니다.</p>
<blockquote>
<ul>
<li>CentOS/RHEL 7.6 and Fedora 28, 29, 30, RHEL system</li>
<li>KVM 가상화를 사용 할 수 있도록 CPU 가상화 기능 활성화</li>
<li>LVM Pool 공간으로 사용될 Free VG 공간</li>
<li>Package 설치를 위한 Public Network 연결 허용</li>
</ul>
</blockquote>
<p><code>fast-vm</code> 설치는 <code>ansible</code> 을 이용하여 간편하게 설치가 가능합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-host ~]# yum -y install ansible
</span></span></code></pre></div><p>먼저 <code>ansible</code> 을 설치합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-host ~]# ansible-galaxy install ondrejhome.fast-vm-server
</span></span><span style="display:flex;"><span>- downloading role &#39;fast-vm-server&#39;, owned by ondrejhome
</span></span><span style="display:flex;"><span>- downloading role from https://github.com/OndrejHome/ansible.fast-vm-server/archive/v6.tar.gz
</span></span><span style="display:flex;"><span>- extracting ondrejhome.fast-vm-server to /etc/ansible/roles/ondrejhome.fast-vm-server
</span></span><span style="display:flex;"><span>- ondrejhome.fast-vm-server (v6) was installed successfully
</span></span><span style="display:flex;"><span>[root@fastvm-host ~]#
</span></span></code></pre></div><p><code>ansible-galaxy</code> 명령을 통해 <code>fast-vm</code> <em>playbook</em> 을 Download 합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-host defaults]# vgs
</span></span><span style="display:flex;"><span>  VG     #PV #LV #SN Attr   VSize   VFree
</span></span><span style="display:flex;"><span>  centos   1   2   0 wz--n- 278.36g &lt;120.37g
</span></span><span style="display:flex;"><span>[root@fastvm-host defaults]#
</span></span></code></pre></div><p>위와 같이 Free Size 의 VG 를 준비합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[<span style="color:#ae81ff">root@fastvm-host defaults]# pwd</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">/etc/ansible/roles/ondrejhome.fast-vm-server/defaults</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@fastvm-host defaults]# cat main.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#75715e">### areas that can be configured by this role</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## configure repositories needed for fast-vm installation</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_repositories</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## install packages needed by fast-vm and fast-vm itself</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">install_fastvm</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## configure libvirt for fast-vm access (change groups and permissions settings)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_libvirt_access</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## configure libvirt network for fast-vm (libvirtd service will be enabled after boot)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_libvirt_network</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## configure storage for fast-vm (create thinpool LV)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## configure sudoers for fast-vm</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_sudoers</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## generate /etc/fast.conf configuration file</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_fastvm_conf</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## install OVMF UEFI firmware needed by UEFI fast-vm machines</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">install_ovmf</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## install and configure fence_virtd that can be used to fence the fast-vm VMs using fence_xvm</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">install_fence_virtd</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## install custom version of qemu-kvm,qemu-img and seabios-bin to support LSI and MEGASAS emaulated drivers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">install_custom_qemu</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### variable that are required by some areas from above</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># all variable has list of &#39;required by&#39; on which above options needs them</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## group with access to fast-vm</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_libvirt_access, config_sudoers, config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_group</span>: <span style="color:#ae81ff">libvirt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## name of VG where fast-vm thinpool LV is located</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_storage, config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_vg</span>: <span style="color:#ae81ff">centos</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## name of fast-vm thinpool LV</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_storage, config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_lv</span>: <span style="color:#ae81ff">fast-vm-pool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## size of fast-vm thinpool LV</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_storage, config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_lv_size</span>: <span style="color:#ae81ff">100G</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## fast-vm network subnet number</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_libvirt_network, config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_net</span>: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## name of fast-vm NAT libvirt network</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_libvirt_network, config_fastvm_conf, install_fence_virt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_net_name</span>: <span style="color:#ae81ff">fast-vm-nat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## prefix for fast-vm VMs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_vm_prefix</span>: <span style="color:#e6db74">&#39;fastvm-&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## fast-vm notes directory - here fast-vm stores VM notes and other VM stateful details</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_notes_dir</span>: <span style="color:#e6db74">&#39;/var/tmp&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Allow only owners of VMs and &#39;root&#39; to delete them</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: config_fastvm_conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_owner_only_delete</span>: <span style="color:#e6db74">&#39;yes&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Multicast address of fence_virt daemon</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># required by: install_fence_virt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fence_virtd_address</span>: <span style="color:#e6db74">&#39;225.0.0.12&#39;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@fastvm-host defaults]#</span>
</span></span></code></pre></div><p><code>/etc/ansible/roles/ondrejhome.fast-vm-server/defaults</code> 위 경로의 <code>main.yml</code> 을 설치 환경에 맞게 설정합니다.   <br>
(현재는 <code>firewalld</code> 설정 관련 Option 을 추가 하였습니다. 상세 내용은 하단에 첨부하도록 하겠습니다.)</p>
<p><code>/etc/ansible/roles/ondrejhome.fast-vm-server/defaults/main.yml</code> 에서 아래 Option 을 시스템 환경에 맞게 설정하였습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">fastvm_vg</span>: <span style="color:#ae81ff">centos</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">fastvm_lv_size</span>: <span style="color:#ae81ff">100G</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[<span style="color:#ae81ff">root@fastvm-host ~]# cat install.yaml</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">hosts</span>: <span style="color:#ae81ff">localhost</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">roles</span>:
</span></span><span style="display:flex;"><span>     - { <span style="color:#f92672">role</span>: <span style="color:#ae81ff">ondrejhome.fast-vm-server }</span>
</span></span></code></pre></div><p>위와 같이 <code>localhost</code> 에 설치하도록 <code>ansible-playbook</code> 을 작성합니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-host ~]# ansible-playbook install.yaml
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>... 중략 ...
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>TASK [ondrejhome.fast-vm-server : make fence_xvm.key readable by everyone] **************************************************************************************
</span></span><span style="display:flex;"><span>ok: [localhost]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>TASK [ondrejhome.fast-vm-server : generate /etc/fence_virt.conf configuration] **************************************************************************************
</span></span><span style="display:flex;"><span>ok: [localhost]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>TASK [ondrejhome.fast-vm-server : start and enable fence_virtd service] **************************************************************************************
</span></span><span style="display:flex;"><span>changed: [localhost]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>TASK [ondrejhome.fast-vm-server : install custom qemu-kvm, qemu-img and seabios-bin packages] **************************************************************************************
</span></span><span style="display:flex;"><span> [WARNING]: Consider using yum module rather than running yum
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>changed: [localhost]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>PLAY RECAP ***************************************************************************
</span></span><span style="display:flex;"><span>localhost                  : ok=28   changed=2    unreachable=0    failed=0
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[root@fastvm-host ~]#
</span></span></code></pre></div><p>위와 같이 설치가 손쉽게 되는 것을 볼 수 있습니다.</p>
<h1 id="fast-vm-운영">Fast-VM 운영<a hidden class="anchor" aria-hidden="true" href="#fast-vm-운영">#</a></h1>
<hr>
<h2 id="show-vm-list">Show VM List<a hidden class="anchor" aria-hidden="true" href="#show-vm-list">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-host ~]# fast-vm list
</span></span><span style="display:flex;"><span>VM# Image name      Status       Profile_name    Size( %used )  Activity  Notes
</span></span><span style="display:flex;"><span>=== Space used:   0.00% of 100.00g
</span></span><span style="display:flex;"><span>[root@fastvm-host ~]#
</span></span></code></pre></div><h2 id="import-os-images">Import OS Images<a hidden class="anchor" aria-hidden="true" href="#import-os-images">#</a></h2>
<p><code>fast-vm</code> Document Page 를 참조하면 다양한 Linux 배포판 Template 가 생성 되어 있고, 사용이 가능합니다.</p>
<ul>
<li>Image List : <a href="https://www.famera.cz/blog/fast-vm/image_list.html">https://www.famera.cz/blog/fast-vm/image_list.html</a></li>
</ul>
<p>해당 Page 를 통해 Os Image 를 Import 하도록 하겠습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host ~]# fast-vm import_image centos-6.9 http://ftp.linux.cz/pub/linux/people/ondrej_famera/fastvm-images/generated/6g__centos-6.9.img.xz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/xml/centos-6.3-current.xml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/hacks/6g_centos-6-hacks.sh 
</span></span><span style="display:flex;"><span>[__][inf] provided empty file path 
</span></span><span style="display:flex;"><span>[__][inf] Detected remote file with size 199916708 
</span></span><span style="display:flex;"><span>[__][inf] provided empty file path 
</span></span><span style="display:flex;"><span>[__][inf] Detected remote file with size 1596 
</span></span><span style="display:flex;"><span>[__][inf] downloading https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/xml/centos-6.3-current.xml 
</span></span><span style="display:flex;"><span>[__]into /tmp/tmp.Ca4rz7xD9y
</span></span><span style="display:flex;"><span>[__][inf] provided empty file path 
</span></span><span style="display:flex;"><span>[__][inf] Detected remote file with size 1334 
</span></span><span style="display:flex;"><span>[__][inf] downloading https://raw.githubusercontent.com/OndrejHome/fast-vm-public-images/master/centos/hacks/6g_centos-6-hacks.sh
</span></span><span style="display:flex;"><span>[__]into /tmp/tmp.6QO7k5K5zK
</span></span><span style="display:flex;"><span>[__][inf] Size of image was determined from the filename to be 6G. 
</span></span><span style="display:flex;"><span>[__][inf] creating LV fastvm-centos-6.9 ... 
</span></span><span style="display:flex;"><span>[__][inf] importing image http://ftp.linux.cz/pub/linux/people/ondrej_famera/fastvm-images/generated/6g__centos-6.9.img.xz into /dev/c7vg/fastvm-centos-6.9 
</span></span><span style="display:flex;"><span>[__][inf] please wait while importing image (to show image write progress, install &#39;pv&#39;)
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current 
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed 
</span></span><span style="display:flex;"><span>100  190M  100  190M    0     0  3180k      0  0:01:01  0:01:01 --:--:-- 55347 
</span></span><span style="display:flex;"><span>0+640923 records in 
</span></span><span style="display:flex;"><span>0+640923 records out
</span></span><span style="display:flex;"><span>6442450944 bytes (6.4 GB) copied, 62.6419 s, 103 MB/s 
</span></span><span style="display:flex;"><span>[__][ok] Image centos-6.9 imported
</span></span><span style="display:flex;"><span>[root@test-vm-host ~]# 
</span></span></code></pre></div><p>위와 같이 Image 를 Download 하고 <code>fast-vm</code> 에 Import 하였습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host ~]# fast-vm list_images  
</span></span><span style="display:flex;"><span>IMAGE                       |SYSTEM                |USER                  | 
</span></span><span style="display:flex;"><span>Image name             Size |XML      Hack file for|XML      Hack file for|
</span></span><span style="display:flex;"><span>centos-6.10              6g |ok       create       |missing  no hack files| 
</span></span><span style="display:flex;"><span>centos-6.9               6g |ok       create       |missing  no hack files| 
</span></span><span style="display:flex;"><span>centos-7.3               6g |ok       create       |missing  no hack files|
</span></span><span style="display:flex;"><span>centos-7.6               6g |ok       create       |missing  no hack files| 
</span></span><span style="display:flex;"><span>centos-7.6-ext           6g |ok       create       |missing  no hack files|
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>NOTE: if image is missing XML it wouldn&#39;t be possible to create a VM from it!
</span></span><span style="display:flex;"><span> Image with missing hack file(s) can work if it&#39;s not needed.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> USER XML and hack file(s) takes precendense before SYSTEM ones.
</span></span><span style="display:flex;"><span>[root@test-vm-host ~]#  
</span></span></code></pre></div><p><code>CentOS 6.9</code> 가 Import 되었습니다.</p>
<h2 id="hack-file-수정">hack file 수정<a hidden class="anchor" aria-hidden="true" href="#hack-file-수정">#</a></h2>
<p>기본적으로 제공된 OS Image 는 유럽 Timezone 이 설정 되어 있습니다.<br>
그리하여 <em>hack file</em> 을 수정하여 아시아 Timezone 으로 변경을 할 수 있고, 이를 응용하여 나만의 Custom Image 를 생성 할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>$ vi /etc/fast-vm/hacks-centos-6.9.sh 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#!/bin/bash
</span></span><span style="display:flex;"><span>## test if guestfish command is present
</span></span><span style="display:flex;"><span>which guestfish 2&gt;&amp;1 &gt; /dev/null
</span></span><span style="display:flex;"><span>if [ &#34;$?&#34; != 0 ]; then
</span></span><span style="display:flex;"><span>        echo &#34;[!!!] Command &#39;guestfish&#39; not found (Install it!). Making changes to VM FAILED.&#34;
</span></span><span style="display:flex;"><span>        exit 1
</span></span><span style="display:flex;"><span>fi
</span></span><span style="display:flex;"><span>## using direct backend to avoid selinux issues on fedora for now
</span></span><span style="display:flex;"><span>export LIBGUESTFS_BACKEND=direct
</span></span><span style="display:flex;"><span>## hostname
</span></span><span style="display:flex;"><span>VM_HOSTNAME=$(echo $VM_NAME|sed -e &#39;s/\./-/g; s/_/-/g&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>guestfish -a &#34;/dev/$THINPOOL_VG/$VM_NAME&#34; -m /dev/c6vg/root_lv -m /dev/sda1:/boot &lt;&lt;EOF
</span></span><span style="display:flex;"><span># configure correct MAC address for eth0 network adapter
</span></span><span style="display:flex;"><span>sh &#39;sed -i &#34;s/HWADDR=.*$/HWADDR=\&#34;${VM_MAC}\&#34;/; s/^ONBOOT=.*$/ONBOOT=\&#34;yes\&#34;/&#34; /etc/sysconfig/network-scripts/ifcfg-eth0&#39;
</span></span><span style="display:flex;"><span># change the hostname of machine
</span></span><span style="display:flex;"><span>sh &#39;sed -i &#34;s/HOSTNAME=.*$/HOSTNAME=$VM_HOSTNAME/&#34; /etc/sysconfig/network&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">++ # Change Timezone 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">++ sh &#39;rm -f /etc/localtime&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">++ sh &#39;ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>
</span></span><span style="display:flex;"><span># CentOS 6.4, 6.4, 6.5 contained broken line in &#39;file_contexts&#39; file, this removes it so we can apply other selinux labels
</span></span><span style="display:flex;"><span>sh &#39;sed -i &#34;/\\pid/d&#34; /etc/selinux/targeted/contexts/files/file_contexts&#39;
</span></span><span style="display:flex;"><span>selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/selinux/targeted/contexts/files/file_contexts
</span></span><span style="display:flex;"><span># relabel files that we were touching with correct SELinux labels
</span></span><span style="display:flex;"><span>selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/sysconfig/network-scripts/ifcfg-eth0
</span></span><span style="display:flex;"><span>selinux-relabel /etc/selinux/targeted/contexts/files/file_contexts /etc/sysconfig/network
</span></span><span style="display:flex;"><span>EOF
</span></span></code></pre></div><p>위와 같이 <code>guestfish</code> 명령을 통해 Image 변경 작업을 할 수 있도록 설정합니다.</p>
<h2 id="start-fast-vm">Start fast-vm<a hidden class="anchor" aria-hidden="true" href="#start-fast-vm">#</a></h2>
<p>수정된 Image 를 이용하여 VM 을 생성 하도록 하겠습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host ~]# fast-vm create centos-6.9 <span style="color:#ae81ff">30</span> 
</span></span><span style="display:flex;"><span>[30][inf] using file /etc/fast-vm/config-centos-6.9.xml as libvirt XML 
</span></span><span style="display:flex;"><span>[30][inf] using file /etc/fast-vm/hacks-centos-6.9.sh as hack file
</span></span><span style="display:flex;"><span>[30][inf] defining virtual machine &#39;fastvm-centos-6.9-30&#39; in libvirt
</span></span><span style="display:flex;"><span>Domain fastvm-centos-6.9-30 defined from /tmp/tmp.AUMMkEdrbo.xml
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Domain title updated successfully
</span></span><span style="display:flex;"><span>[30][inf] creating disk &#39;fastvm-centos-6.9-30&#39; 
</span></span><span style="display:flex;"><span>[30][inf] adding static lease for 192.168.200.30 into libvirts DHCP 
</span></span><span style="display:flex;"><span>[30][inf] applying hacks from /etc/fast-vm/hacks-centos-6.9.sh 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[30][inf] applying hacks finished 
</span></span><span style="display:flex;"><span>[30][ok] VM &#39;fastvm-centos-6.9-30&#39; created 
</span></span></code></pre></div><p>VM ID 30 으로 VM 이 생성 되었습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host ~]# fast-vm start <span style="color:#ae81ff">30</span> 
</span></span><span style="display:flex;"><span>[30][inf] starting VM fastvm-centos-6.9-30 (192.168.200.30) 
</span></span><span style="display:flex;"><span>Domain fastvm-centos-6.9-30 started 
</span></span></code></pre></div><p>VM ID 30 의 VM 을 시작 하였습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host ~]# fast-vm ssh <span style="color:#ae81ff">30</span> 
</span></span><span style="display:flex;"><span>[30][inf] checking the 192.168.200.30 for active SSH connection (ctrl+c to interrupt) 
</span></span><span style="display:flex;"><span>................[30][inf]  
</span></span><span style="display:flex;"><span>[30]SSH ready
</span></span><span style="display:flex;"><span>Warning: Permanently added &#39;192.168.200.30&#39; (RSA) to the list of known hosts. 
</span></span><span style="display:flex;"><span>root@192.168.200.30&#39;s password:  
</span></span></code></pre></div><p><code>fast-vm ssh</code> 명령을 통해 해당 VM 에 <code>ssh</code> 로 접속을 합니다.<br>
시스템이 부팅중일 경우, <code>ssh</code> 서비스가 시작 될 때까지 접속 대기합니다.</p>
<ul>
<li>참고 : 기본적으로 사용되는 이미지의 <code>root</code> 비밀번호는 <code>testtest</code> 입니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@fastvm-centos-6-9-30 ~]# cat /etc/redhat-release  
</span></span><span style="display:flex;"><span>CentOS release 6.9 (Final) 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[root@fastvm-centos-6-9-30 ~]# date 
</span></span><span style="display:flex;"><span>Fri Aug 16 11:02:43 KST 2019
</span></span></code></pre></div><p>위와 같이 VM 이 생성 및 시작, hack file 이 적용된 것을 확인 할 수 있습니다.</p>
<h2 id="delete-fast-vm">Delete fast-vm<a hidden class="anchor" aria-hidden="true" href="#delete-fast-vm">#</a></h2>
<p>아래 명령을 통해 사용을 다한 <code>fast-vm</code> 을 삭제 할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>[root@test-vm-host fast-vm]# fast-vm delete <span style="color:#ae81ff">30</span> 
</span></span><span style="display:flex;"><span>[30][wrn] VM fastvm-centos-6.9-30 is active, forcefully stopping it 
</span></span><span style="display:flex;"><span>Domain fastvm-centos-6.9-30 destroyed 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[30][inf] removing DHCP reservation 192.168.200.30 for 52:54:00:96:5c:80
</span></span><span style="display:flex;"><span>Updated network fast-vm-nat persistent config and live state 
</span></span><span style="display:flex;"><span>[30][inf] removing VM drive 
</span></span><span style="display:flex;"><span>[30][inf] undefining VM fastvm-centos-6.9-30 from libvirt 
</span></span><span style="display:flex;"><span>Domain fastvm-centos-6.9-30 has been undefined 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>[30][ok] VM &#39;fastvm-centos-6.9-30&#39; deleted 
</span></span><span style="display:flex;"><span>[root@test-vm-host fast-vm]#
</span></span></code></pre></div><p>해당 VM 이 삭제 되었습니다.</p>
<h1 id="fast-vm-에-pr-을-해보자">fast-vm 에 PR 을 해보자!<a hidden class="anchor" aria-hidden="true" href="#fast-vm-에-pr-을-해보자">#</a></h1>
<hr>
<p><code>fast-vm</code> 은 Open Source Solution 으로 언제나 Github를 통해 PR 을 할 수 있습니다.<br>
저의 경우, 아래와 같은 이슈로 인해 PR 진행 하였습니다.</p>
<ul>
<li><code>firewalld</code> deamon 의 <code>disable</code> 로 인한 배포 실패</li>
<li>지원하는 <code>ansible</code> 최소버전에 대한 이슈. ( <a href="https://docs.ansible.com/ansible/2.5/modules/yum_module.html"><code>yum</code> Module <code>update_only</code> option 관련</a> )</li>
</ul>
<!-- raw HTML omitted -->
<p>위와 같이 PR 을 생성하고 현재는 <code>Source</code> 에 <code>Merge</code> 되었습니다.</p>
<h1 id="마치며">마치며<a hidden class="anchor" aria-hidden="true" href="#마치며">#</a></h1>
<p>위에서 소개한 <code>fast-vm</code> 의 부분은 극히 필수적인 요소들입니다.<br>
libvirtd 에서 제공하는 다양한 부분을 지원하고 있으며, 해당 내용은 아래 <em>참고 문서</em> 를 확인 바람니다.</p>
<p>***사용 중 발생된 이슈/추가 기능 구현 관련에 대해 <code>github</code> 를 통해 PR 할 수 있습니다.   ***</p>
<h1 id="참고-문서">참고 문서<a hidden class="anchor" aria-hidden="true" href="#참고-문서">#</a></h1>
<ul>
<li>github : <a href="https://github.com/OndrejHome/ansible.fast-vm-server">https://github.com/OndrejHome/ansible.fast-vm-server</a></li>
<li>Fast-VM User Guide : <a href="https://www.famera.cz/blog/fast-vm/user_guide.html">https://www.famera.cz/blog/fast-vm/user_guide.html</a></li>
<li>Fast-VM Image List : <a href="https://www.famera.cz/blog/fast-vm/image_list.html">https://www.famera.cz/blog/fast-vm/image_list.html</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://chhanz88.github.io/tags/linux/">linux</a></li>
      <li><a href="https://chhanz88.github.io/tags/fast-vm/">fast-vm</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://chhanz88.github.io">chhanz 기술 블로그
</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
